name: Build and Deploy

on:
  push:
    branches:
      - master
  workflow_dispatch:

env:
  REGISTRY: docker.io
  IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/ewu

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 登录 Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: 提取镜像元数据
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=
            type=raw,value=latest

      - name: 构建并推送镜像
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            POSTGRES_URL=${{ secrets.POSTGRES_URL }}
            NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }}
            NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
            AUTH_SECRET=${{ secrets.AUTH_SECRET }}
            BASE_URL=${{ secrets.NEXTAUTH_URL }}
            STRIPE_SECRET_KEY=${{ secrets.STRIPE_SECRET_KEY }}
            STRIPE_WEBHOOK_SECRET=${{ secrets.STRIPE_WEBHOOK_SECRET }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: 部署到服务器
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          envs: POSTGRES_URL,NEXTAUTH_URL,NEXTAUTH_SECRET,AUTH_SECRET,BASE_URL,STRIPE_SECRET_KEY,STRIPE_WEBHOOK_SECRET,DOCKERHUB_USERNAME
          script: |
            set -e

            echo "=== 开始部署 ==="

            # 清理环境变量
            export POSTGRES_URL=$(echo "$POSTGRES_URL" | tr -d '\n\r' | xargs | awk '{print $1}')
            export NEXTAUTH_URL=$(echo "$NEXTAUTH_URL" | tr -d '\n\r' | xargs | awk '{print $1}')
            export NEXTAUTH_SECRET=$(echo "$NEXTAUTH_SECRET" | tr -d '\n\r' | xargs | awk '{print $1}')
            export AUTH_SECRET=$(echo "$AUTH_SECRET" | tr -d '\n\r' | xargs | awk '{print $1}')
            export BASE_URL=$(echo "$BASE_URL" | tr -d '\n\r' | xargs | awk '{print $1}')
            export STRIPE_SECRET_KEY=$(echo "$STRIPE_SECRET_KEY" | tr -d '\n\r' | xargs | awk '{print $1}')
            export STRIPE_WEBHOOK_SECRET=$(echo "$STRIPE_WEBHOOK_SECRET" | tr -d '\n\r' | xargs | awk '{print $1}')

            # 创建部署目录
            mkdir -p /opt/ewu
            cd /opt/ewu

            # 创建 .env 文件
            echo "正在配置环境变量..."
            cat > .env << EOF
            NODE_ENV=production
            POSTGRES_URL=${POSTGRES_URL}
            NEXTAUTH_URL=${NEXTAUTH_URL}
            NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
            AUTH_SECRET=${AUTH_SECRET}
            BASE_URL=${BASE_URL}
            STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
            STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET}
            EOF

            # 创建 docker-compose.yml
            echo "正在创建 docker-compose.yml..."
            cat > docker-compose.yml << 'COMPOSE'
            version: '3.8'
            services:
              app:
                image: ${DOCKERHUB_USERNAME}/ewu:latest
                container_name: ewu-app
                restart: unless-stopped
                ports:
                  - "3000:3000"
                env_file:
                  - .env
                environment:
                  - NODE_ENV=production
            COMPOSE

            # 拉取最新镜像
            echo "正在拉取最新镜像..."
            docker pull ${DOCKERHUB_USERNAME}/ewu:latest

            # 停止并删除旧容器
            echo "正在停止旧容器..."
            docker-compose down || true

            # 启动新容器
            echo "正在启动新容器..."
            docker-compose up -d

            # 等待容器启动
            sleep 5

            # 检查容器状态
            echo "=== 容器状态 ==="
            docker-compose ps

            echo "=== 容器日志 ==="
            docker-compose logs --tail=30

            echo "=== 部署完成 ==="
        env:
          POSTGRES_URL: ${{ secrets.POSTGRES_URL }}
          NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
          AUTH_SECRET: ${{ secrets.AUTH_SECRET }}
          BASE_URL: ${{ secrets.NEXTAUTH_URL }}
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
