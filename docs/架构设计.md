# 公司落地页项目架构设计

## 1. 架构概述

### 1.1 项目定位

小型公司官网系统，支持文件上传、支付集成等核心功能。

**规模预估**
- 日活用户: < 1000
- 并发请求: < 100
- 数据量: < 10万条记录

### 1.2 技术栈

| 层级 | 技术选型 | 选型理由 |
|------|----------|----------|
| **前端框架** | Next.js 15 + React 19 | 全栈框架，原生SSR/SSG支持，SEO友好 |
| **类型系统** | TypeScript 5.x | 类型安全，减少运行时错误 |
| **样式方案** | Tailwind CSS 4 | 原子化CSS，开发效率高 |
| **UI组件库** | Shadcn/ui + Radix UI | 高质量可定制组件，无运行时依赖 |
| **后端框架** | Next.js API Routes | 前后端一体化，减少技术栈复杂度 |
| **ORM框架** | Drizzle ORM | 轻量高性能，TypeScript原生支持 |
| **数据库** | SQLite / PostgreSQL | 开发环境SQLite，生产环境PostgreSQL |
| **进程管理** | PM2 | 自动重启、负载均衡、日志管理 |
| **反向代理** | Nginx | 静态文件服务、SSL终止、Gzip压缩 |

---

## 2. 系统架构

### 2.1 分层架构

```
┌─────────────────────────────────────────────────────────┐
│                    表现层 (Presentation)                  │
│  - Next.js Pages (SSR/SSG)                              │
│  - React Components                                     │
│  - Tailwind CSS Styles                                  │
└─────────────────────────────────────────────────────────┘
                            │
┌─────────────────────────────────────────────────────────┐
│                    业务逻辑层 (Business)                  │
│  - API Routes (RESTful)                                 │
│  - Business Logic Functions                             │
└─────────────────────────────────────────────────────────┘
                            │
┌─────────────────────────────────────────────────────────┐
│                    数据访问层 (Data Access)               │
│  - Drizzle ORM                                          │
│  - Database Queries                                     │
│  - Data Validation                                      │
└─────────────────────────────────────────────────────────┘
                            │
┌─────────────────────────────────────────────────────────┐
│                    数据存储层 (Storage)                   │
│  - SQLite (Development)                                 │
│  - PostgreSQL (Production)                              │
└─────────────────────────────────────────────────────────┘
```

### 2.2 核心模块

**前端模块**
- 公开页面: 首页、关于我们、联系我们
- 管理后台: 仪表盘、系统配置

**后端模块**
- 上传API: 文件上传、图片处理
- 支付API: 微信支付、支付宝集成

---

## 3. 目录结构

```
ewu/
├── src/
│   ├── app/                    # Next.js App Router
│   │   ├── (public)/           # 公开路由组
│   │   ├── admin/              # 管理后台
│   │   └── api/                # API路由
│   │
│   ├── components/             # React组件
│   │   ├── ui/                 # 基础UI组件
│   │   ├── layout/             # 布局组件
│   │   ├── admin/              # 后台组件
│   │   └── shared/             # 共享组件
│   │
│   ├── lib/                    # 业务逻辑库
│   │   ├── db/                 # 数据库层
│   │   ├── payment/            # 支付集成
│   │   └── utils/              # 工具函数
│   │
│   ├── hooks/                  # React Hooks
│   ├── types/                  # TypeScript类型
│   └── middleware.ts           # 路由中间件
│
├── drizzle/                    # 数据库迁移
├── scripts/                    # 脚本工具
└── docs/                       # 项目文档
```

**模块职责说明**

| 目录 | 职责 |
|------|------|
| `app/` | 路由定义、页面组件、API端点 |
| `components/` | 可复用UI组件 |
| `lib/db/` | 数据库Schema、查询函数 |
| `hooks/` | 自定义React Hooks |
| `types/` | TypeScript类型定义 |

---

## 4. 数据模型设计

### 4.1 核心实体

```
┌─────────────┐         ┌─────────────┐
│   Orders    │         │   Files     │
├─────────────┤         ├─────────────┤
│ id          │         │ id          │
│ order_no    │         │ filename    │
│ amount      │         │ path        │
│ status      │         │ size        │
│ payment_type│         │ mime_type   │
│ paid_at     │         │ created_at  │
│ created_at  │         └─────────────┘
│ updated_at  │
└─────────────┘
```

### 4.2 实体关系

Orders 和 Files 表为独立实体，无外键关联。

### 4.3 关键字段说明

**Orders (订单表)**
- `order_no`: 订单号，唯一标识
- `status`: 订单状态 (pending/paid/cancelled)
- `payment_type`: 支付方式 (wechat/alipay)

**Files (文件表)**
- `path`: 文件存储路径
- `mime_type`: 文件MIME类型

---

## 5. 部署架构

### 5.1 生产环境架构

```
Internet
   │
   ▼
┌──────────────────────────────────────┐
│  Nginx (80/443)                      │
│  - SSL/TLS 终止                       │
│  - 静态文件服务                        │
│  - Gzip 压缩                          │
│  - 反向代理                           │
└──────────────────────────────────────┘
   │
   ▼
┌──────────────────────────────────────┐
│  PM2 进程管理                         │
│  - Cluster 模式                       │
│  - 自动重启                           │
│  - 负载均衡                           │
└──────────────────────────────────────┐
   │
   ▼
┌──────────────────────────────────────┐
│  Next.js App (3000)                  │
│  - SSR/SSG 渲染                       │
│  - API Routes                        │
└──────────────────────────────────────┘
   │
   ▼
┌──────────────────────────────────────┐
│  PostgreSQL                          │
│  - 业务数据                           │
└──────────────────────────────────────┘
```

### 5.2 关键组件

| 组件 | 职责 | 配置要点 |
|------|------|----------|
| **Nginx** | 反向代理、静态文件服务 | SSL证书、Gzip压缩、缓存策略 |
| **PM2** | 进程管理 | Cluster模式、自动重启、日志管理 |
| **Next.js** | 应用服务 | 环境变量、构建优化 |
| **PostgreSQL** | 数据存储 | 连接池、索引优化 |

### 5.3 环境差异

| 配置项 | 开发环境 | 生产环境 |
|--------|----------|----------|
| 数据库 | SQLite | PostgreSQL |
| 域名 | localhost:3000 | yourdomain.com |
| HTTPS | 否 | 是 |
| 代码压缩 | 否 | 是 |
| Source Map | 是 | 否 |

---

## 6. CI/CD 流程

### 6.1 CI/CD 架构

```
开发者
   │
   ▼
Git Push
   │
   ▼
┌──────────────────────────────────────┐
│  Git 仓库 (GitHub/GitLab)            │
└──────────────────────────────────────┘
   │
   ▼ (Webhook 触发)
┌──────────────────────────────────────┐
│  CI/CD 平台                          │
│  - GitHub Actions / GitLab CI        │
│  - 代码检查                           │
│  - 自动化测试                         │
│  - 构建打包                           │
└──────────────────────────────────────┘
   │
   ▼ (SSH 部署)
┌──────────────────────────────────────┐
│  云服务器                             │
│  1. 拉取最新代码                      │
│  2. 安装依赖                          │
│  3. 数据库迁移                        │
│  4. 构建应用                          │
│  5. PM2 重启                          │
└──────────────────────────────────────┘
```

### 6.2 工具选型

| 工具 | 用途 | 选型理由 |
|------|------|----------|
| **GitHub Actions** | CI/CD 平台 | 与 GitHub 深度集成，免费额度充足 |
| **GitLab CI** | CI/CD 平台（备选） | 私有化部署，功能完善 |
| **SSH** | 部署方式 | 直接部署到云服务器，简单可靠 |
| **PM2** | 进程管理 | 零停机重启，自动回滚 |

### 6.3 CI/CD 流程

**持续集成 (CI)**
1. 代码提交触发 Webhook
2. 代码质量检查（ESLint、TypeScript）
3. 运行自动化测试
4. 构建验证

**持续部署 (CD)**
1. 通过 SSH 连接到云服务器
2. 拉取最新代码
3. 安装依赖（pnpm install）
4. 运行数据库迁移
5. 构建生产版本（pnpm build）
6. PM2 重启应用（零停机）

### 6.4 部署策略

| 策略 | 说明 | 适用场景 |
|------|------|----------|
| **滚动更新** | PM2 逐个重启进程 | 日常更新，零停机 |
| **蓝绿部署** | 维护两套环境，切换流量 | 重大版本更新 |
| **回滚机制** | PM2 保存历史版本，快速回滚 | 部署失败时 |

### 6.5 关键配置

**环境变量管理**
- 敏感信息存储在 CI/CD 平台的 Secrets 中
- 通过 SSH 部署时注入到服务器

**部署权限**
- 使用 SSH 密钥认证
- 限制 CI/CD 用户权限（只能操作应用目录）

**健康检查**
- 部署后自动检查应用状态
- 失败时自动回滚

---

## 7. 关键设计决策

### 7.1 全栈框架选择

**决策**: 使用 Next.js 作为全栈框架

**理由**:
- 前后端一体化，减少技术栈复杂度
- 原生 SSR/SSG 支持，SEO 友好
- API Routes 提供后端能力，无需单独后端服务
- 统一的 TypeScript 类型系统

### 7.2 数据库双环境策略

**决策**: 开发环境使用 SQLite，生产环境使用 PostgreSQL

**理由**:
- SQLite: 零配置，快速启动，适合开发和测试
- PostgreSQL: 生产级性能，并发支持，数据完整性
- Drizzle ORM 提供统一抽象层，平滑迁移

### 7.3 样式方案

**决策**: Tailwind CSS + Shadcn/ui

**理由**:
- Tailwind: 原子化 CSS，开发效率高，构建体积小
- Shadcn/ui: 高质量组件，无运行时依赖，完全可定制
- 2024-2025 年主流方案，社区活跃

### 7.4 CI/CD 方案

**决策**: GitHub Actions + SSH 部署

**理由**:
- GitHub Actions: 与代码仓库深度集成，配置简单
- SSH 部署: 直接部署到云服务器，灵活可控
- PM2: 零停机重启，自动回滚机制

---

## 8. 架构总结

### 8.1 架构特点

- **全栈一体化**: Next.js 统一前后端，降低复杂度
- **环境灵活性**: SQLite/PostgreSQL 双环境支持
- **SEO 友好**: SSR/SSG 原生支持
- **类型安全**: TypeScript 全栈类型系统
- **部署简单**: 标准 Node.js 应用，兼容各类云服务器
- **自动化部署**: CI/CD 流程，零停机更新

### 8.2 技术优势

| 维度 | 优势 |
|------|------|
| **开发效率** | 全栈框架、组件库、类型系统 |
| **性能** | SSR/SSG、代码分割、图片优化 |
| **SEO** | 服务端渲染、语义化 HTML |
| **可维护性** | TypeScript、模块化、清晰分层 |
| **扩展性** | 模块化设计、ORM 抽象层 |
| **自动化** | CI/CD 流程、自动化测试、自动部署 |

### 8.3 适用场景

✅ **适合**:
- 小型企业官网（日活 < 1000）
- SEO 要求高的项目
- 快速开发和迭代
- 需要自动化部署的项目

❌ **不适合**:
- 高并发场景（日活 > 10000）
- 实时性要求极高的应用
- 复杂的微服务架构

---

**文档版本**: 2.0
**最后更新**: 2026-01-19
**维护者**: 开发团队

